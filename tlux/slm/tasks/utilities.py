# Utilities for the handbook follower framework.

import os
import re
import subprocess
# from tlux.slm import chat_complete as base_chat_complete
# from tlux.slm import server_chat_complete as base_chat_complete
from tlux.slm import logged_server_chat_complete as chat_complete
from tlux.decorators import cache


# Given markdown text, extract the contents of the first (and presumed only) code block.
def extract_code(markdown_text_with_code_block: str) -> str:
    # This regex matches a markdown code block with an optional language specifier.
    # It uses DOTALL so that '.' matches newline characters.
    pattern = re.compile(r"```(?:\w+)?\s*\n(.*?)```", re.DOTALL)
    match = pattern.search(markdown_text_with_code_block)
    if match:
        code_content = match.group(1)
    else:
        code_content = ""
    # Return the extracted code content.
    return code_content


# Remove quote and code block wrappers from strings (to only get the
# "contents" intended). If there is whitespace in a generic, assume
# the contents stop at the first appearance of whitespace.
def remove_wrappers(s):
    # Pattern to match different wrappers
    pattern = r'^(?:"(.*)"|\'(.*)\'|```([^\s]*\s)?(.*)```|`(.*)`|(\S+).*)$'
    # Match the pattern, allowing . to match newlines
    match = re.match(pattern, s, re.DOTALL)
    if match:
        groups = match.groups()
        # Check if it's a code block (group 4, index 3)
        if groups[3] is not None:
            return groups[3].rstrip('\n')
        # Return the last non-None group for other cases
        for group in reversed(groups):
            if group is not None:
                return group
    # If no match, return original string trimmed of whitespace
    return s.strip()


# Create a virtual environment for sandboxing workers.
def setup_venv(venv_dir: str):
    if not os.path.exists(venv_dir):
        subprocess.check_call([sys.executable, "-m", "venv", venv_dir])


# Split manual text into chunks, use paragraph breaks.
def split_text_by_paragraph(text: str, max_tokens: int=42) -> list[str]:
    splitter = "\n\n"
    paragraphs = text.split(splitter)
    chunks = []
    current_chunk = ""
    current_tokens = 0
    for para in paragraphs:
        # Token count estimate comes from "words" (whitespace separated, or 5 characters).
        para_tokens = max(len(para.split()), len(para) // 5)
        # Either append to the current chunk (if still short enough) or create a new one.
        if current_tokens + para_tokens > max_tokens:
            if current_chunk:
                chunks.append(current_chunk.strip())
            current_chunk = para
        else:
            current_chunk += splitter + para if current_chunk else para
        # Accumulate the tokens.
        current_tokens += para_tokens
    # Add any leftover text into the last chunk.
    if current_chunk:
        chunks.append(current_chunk.strip())
    return chunks


# Generate multiple different rephrasings of a given snippet of text.
def rephrase(phrase: str, new_phrasings: int = 4) -> list[str]:
    assert (len(phrase.split()) < 69), f"Expect a 'short' text to rephrase, but got {len(phrase)} characters and {len(phrase.split())} words."
    prompt = "Please rephrase this block of text without alterning its meaning and respond with something similar but different.\n\n```\n{0}\n```\n\nPlease respond only with your new phrasing and nothing else."
    messages = [prompt.format(phrase.replace("```\n", "```code\n"))]
    phrasings = [phrase]
    for _ in range(new_phrasings):
        new_phrasing, _ = chat_complete(
            messages=messages,
            temperature=0.0,
        )
        phrasings.append(new_phrasing)
        # Continue the conversation (so that it doesn't diverge nor repeat itself too heavily).
        messages.extend([
            new_phrasing,
            "Great work. Please produce another.",
        ])
    # Return the list of new phrasings.
    return phrasings


# Create multiple completions and return the best of them.
def complete_best(messages, num_tries=3, temperature=0.0):
    assert (len(messages) % 2 == 1), "Must provide an odd number of messages (alternating turns ending with a user prompt)."
    completions = []
    phrasings = rephrase(messages[-1], new_phrasings=num_tries-1)
    for p in phrasings:
        messages[-1] = p
        result, _ = chat_complete(messages=messages, temperature=temperature)
        completions.append(result)
        completions.append("Acknowledged.")
    # Combine completions.
    final_result, _ = chat_complete(
        messages=[
            f"Below, I will provide {num_tries} different completions for a prompt. Your job will be to merge the completions into one coherent completion.",
            "Understood. Please provide the completions one at a time. I will acknowledge each.",
            *completions,
            "Now please merge the completions and provide a single coherent response.",
        ],
    )
    # Return the final completion.
    return final_result


# Create a completion that adheres to specified options.
def complete_from_options(options: list[str], reasoning_attempts=0, max_retries=2, **complete_kwargs):
    # Come up with a simplified set of options (remove unnecessary tokens).
    options_set = {o.strip().lower(): o for o in options}
    # Create a message that can be used to request the model select from a set of options.
    options_text = "Answer only with '" + "', '".join(options[:-1]) + f"' or '{options[-1]}' please."
    # Append the modifier to the appropriate place.
    if "prompt" in complete_kwargs:
        prompt = complete_kwargs.pop("prompt")
        messages = list(complete_kwargs.pop("messages", []))
        messages.append(prompt)
    elif "messages" in complete_kwargs:
        messages = list(complete_kwargs.pop("messages"))
    else:
        raise(ValueError("Did not find 'prompt' nor 'messages' in the keyword arguments for completion. Cannot enforce option selection without one of those."))
    votes = {o: 0 for o in options_set}
    # Construct multiple prompts for reasoning.
    reasoning_text = "Explain your thinking."
    if reasoning_attempts > 1:
        reasoning_text_values = rephrase(reasoning_text, new_phrasings=reasoning_attempts-1)
    else:
        reasoning_text_values = [reasoning_text]
    # Iterate over solutions.
    source_messages = list(messages)
    for reasoning_text in reasoning_text_values:
        messages = list(source_messages)
        # Generate reasoning if appropriate.
        if reasoning_attempts > 0:
            messages[-1] += " " + reasoning_text
            reasoning, _ = chat_complete(
                messages=messages,
                **complete_kwargs,
            )
            messages.extend([
                reasoning,
                "Given your thoughts, now " + options_text.lower(),
            ])
        else:
            messages[-1] += " " + options_text
        # Use chat_complete to evaluate if the result meets the expected outcome.
        for _ in range(max_retries):
            evaluation, stop_reason = chat_complete(
                messages=messages,
                **complete_kwargs,
            )
            # Reduce to the chosen option.
            chosen_option = evaluation.strip().rstrip(".").lower()
            if chosen_option in options_set:
                break
            else:
                complete_kwargs["messages"].extend([
                    evaluation,
                    "That was an invalid response. " + options_text
                ])
        else:
            raise(RuntimeError("Could not get the model to reply with provided options.\n\n" + ("\n" + "-"*80 + "\n").join(complete_kwargs["messages"])))
        # Store the vote.
        votes[chosen_option] += 1
    # Select the most voted option.
    most_voted_option = max(votes, key=votes.get)
    # Return the selected option.
    return options_set[most_voted_option]


if __name__ == "__main__":
    pass


# 2025-04-09 15:45:59
# 
#####################################################################################################################################################################################################################################################################################################################################################################################
# prompt = """                                                                                                                                                                                                                                                                                                                                                                      #
# You have been given a high level objective and a history of your previous actions. At the end, you will be asked to pick one of the actions in order to advance towards the goal.                                                                                                                                                                                                 #
#                                                                                                                                                                                                                                                                                                                                                                                   #
# Provided objective:                                                                                                                                                                                                                                                                                                                                                               #
# ```                                                                                                                                                                                                                                                                                                                                                                               #
# Write a function to compute the Fibonacci sequence.                                                                                                                                                                                                                                                                                                                               #
# ```                                                                                                                                                                                                                                                                                                                                                                               #
#                                                                                                                                                                                                                                                                                                                                                                                   #
# Operational history:                                                                                                                                                                                                                                                                                                                                                              #
#                                                                                                                                                                                                                                                                                                                                                                                   #
# ```                                                                                                                                                                                                                                                                                                                                                                               #
# No actions have been taken yet.                                                                                                                                                                                                                                                                                                                                                   #
# ```                                                                                                                                                                                                                                                                                                                                                                               #
#                                                                                                                                                                                                                                                                                                                                                                                   #
# Available actions:                                                                                                                                                                                                                                                                                                                                                                #
# ```                                                                                                                                                                                                                                                                                                                                                                               #
# create_file(filename, content) - Creates a new file or overwrites an existing one with specified content, handling directory existence and file creation.                                                                                                                                                                                                                         #
# modify_file(filename, changes) - Modifies an existing file by applying specified changes to its contents.                                                                                                                                                                                                                                                                         #
# run_file(filename) - Executes a specified Python file in a virtual environment with the newest available Python 3, returning the execution output or an error message if the file does not exist or cannot be executed.                                                                                                                                                           #
# read_file(filename) - Reads the contents of a specified file, splitting it into chunks if necessary.                                                                                                                                                                                                                                                                              #
# see_all_files() - Returns a list of file paths relative to the root directory, including all files in the root directory and its subdirectories.                                                                                                                                                                                                                                  #
# install_dependency(dependency) - Installs a specified Python module in a virtual environment.                                                                                                                                                                                                                                                                                     #
# ```                                                                                                                                                                                                                                                                                                                                                                               #
#                                                                                                                                                                                                                                                                                                                                                                                   #
#                                                                                                                                                                                                                                                                                                                                                                                   #
#                                                                                                                                                                                                                                                                                                                                                                                   #
# According to the operating manual, this is the suggestion for a next step:                                                                                                                                                                                                                                                                                                        #
# ```                                                                                                                                                                                                                                                                                                                                                                               #
# The next step would likely involve writing a Python function to compute the Fibonacci sequence, as it is a specific problem that needs to be solved according to the provided objective. This function should include extensive comments, a test call with a print statement to demonstrate correctness when run, and unit tests to verify the expected behavior of the function. #
# ```                                                                                                                                                                                                                                                                                                                                                                               #
#                                                                                                                                                                                                                                                                                                                                                                                   #
# Given the objective and history of operations, describe what do you think the general next step that should be taken and then which actions are most likely to achieve that.                                                                                                                                                                                                      #
# """                                                                                                                                                                                                                                                                                                                                                                               #
#                                                                                                                                                                                                                                                                                                                                                                                   #
# print(prompt)                                                                                                                                                                                                                                                                                                                                                                     #
# for _ in split_text_by_paragraph(prompt, max_tokens=10):                                                                                                                                                                                                                                                                                                                          #
#     print("-"*100)                                                                                                                                                                                                                                                                                                                                                                #
#     print(_)                                                                                                                                                                                                                                                                                                                                                                      #
# exit()                                                                                                                                                                                                                                                                                                                                                                            #
#                                                                                                                                                                                                                                                                                                                                                                                   #
# result = complete_best(                                                                                                                                                                                                                                                                                                                                                           #
#     messages=[                                                                                                                                                                                                                                                                                                                                                                    #
#         prompt,                                                                                                                                                                                                                                                                                                                                                                   #
#     ]                                                                                                                                                                                                                                                                                                                                                                             #
# )                                                                                                                                                                                                                                                                                                                                                                                 #
# print()                                                                                                                                                                                                                                                                                                                                                                           #
# print("-"*100)                                                                                                                                                                                                                                                                                                                                                                    #
# print(result)                                                                                                                                                                                                                                                                                                                                                                     #
# exit()                                                                                                                                                                                                                                                                                                                                                                            #
#####################################################################################################################################################################################################################################################################################################################################################################################


# 2025-04-09 15:46:25
# 
########################################################################################################################################################################################################################################################################################################################################################################################################################################################
#     manual = """                                                                                                                                                                                                                                                                                                                                                                                                                                     #
#                                                                                                                                                                                                                                                                                                                                                                                                                                                      #
# # Coder Manual                                                                                                                                                                                                                                                                                                                                                                                                                                       #
#                                                                                                                                                                                                                                                                                                                                                                                                                                                      #
# You will be given work in the form of an instruction or objective from a developer. You should author code to solve the problems provided by the developer. When writing code files, you should always also have tests for the code to verify (basic) correctness. Make sure to run all the tests and verify they pass before you claim completion.                                                                                                  #
#                                                                                                                                                                                                                                                                                                                                                                                                                                                      #
# ## Best Practices                                                                                                                                                                                                                                                                                                                                                                                                                                    #
#                                                                                                                                                                                                                                                                                                                                                                                                                                                      #
# - When writing a python file, include a `if __name__ == "__main__":` block with a test call to the function and print statement to demonstrate correctness when run.                                                                                                                                                                                                                                                                                 #
# - Write extensive comments throughout code to describe what you are doing and make it readable and accessible.                                                                                                                                                                                                                                                                                                                                       #
# - Consider performance and security when writing code; when there are known vulnerabilities, be sure to inform the developer.                                                                                                                                                                                                                                                                                                                        #
# - Always use unit tests (with mocks if appropriate) to verify the expected behavior of functions you author.                                                                                                                                                                                                                                                                                                                                         #
# - When writing tests, focus on the most simple and clear cut cases to be sure the tests don't become too complicated.                                                                                                                                                                                                                                                                                                                                #
# - It is preferred for you to use only the standard library and not rely on external modules to solve problems.                                                                                                                                                                                                                                                                                                                                       #
#                                                                                                                                                                                                                                                                                                                                                                                                                                                      #
# ## Tools                                                                                                                                                                                                                                                                                                                                                                                                                                             #
#                                                                                                                                                                                                                                                                                                                                                                                                                                                      #
# ```                                                                                                                                                                                                                                                                                                                                                                                                                                                  #
# # Write content to a specified file. If the file already exists, an                                                                                                                                                                                                                                                                                                                                                                                  #
# # error will be raised. If the specified directories do not exist,                                                                                                                                                                                                                                                                                                                                                                                   #
# # they will be created.                                                                                                                                                                                                                                                                                                                                                                                                                              #
# #                                                                                                                                                                                                                                                                                                                                                                                                                                                    #
# # Arguments:                                                                                                                                                                                                                                                                                                                                                                                                                                         #
# #   filename - A string specifying the path to the file relative to                                                                                                                                                                                                                                                                                                                                                                                  #
# #              the root directory.                                                                                                                                                                                                                                                                                                                                                                                                                   #
# #   content - A string containing the text to write to the file (e.g.,                                                                                                                                                                                                                                                                                                                                                                               #
# #             Python code, test cases, or any text data).                                                                                                                                                                                                                                                                                                                                                                                            #
# #                                                                                                                                                                                                                                                                                                                                                                                                                                                    #
# # Returns:                                                                                                                                                                                                                                                                                                                                                                                                                                           #
# #   A string with a confirmation message indicating whether the write                                                                                                                                                                                                                                                                                                                                                                                #
# #   operation was successful.                                                                                                                                                                                                                                                                                                                                                                                                                        #
# #                                                                                                                                                                                                                                                                                                                                                                                                                                                    #
# def create_file(filename: str, content: str) -> str:                                                                                                                                                                                                                                                                                                                                                                                                 #
#     ...                                                                                                                                                                                                                                                                                                                                                                                                                                              #
#                                                                                                                                                                                                                                                                                                                                                                                                                                                      #
# # Alter the contents of an existing file to meet specified changes.                                                                                                                                                                                                                                                                                                                                                                                  #
# #                                                                                                                                                                                                                                                                                                                                                                                                                                                    #
# # Arguments:                                                                                                                                                                                                                                                                                                                                                                                                                                         #
# #   filename - A string specifying the path to an existing file                                                                                                                                                                                                                                                                                                                                                                                      #
# #              relative to the root directory.                                                                                                                                                                                                                                                                                                                                                                                                       #
# #   changes - A plain text description of the changes that should be                                                                                                                                                                                                                                                                                                                                                                                 #
# #             made to the contents of the existing file.                                                                                                                                                                                                                                                                                                                                                                                             #
# #                                                                                                                                                                                                                                                                                                                                                                                                                                                    #
# # Returns:                                                                                                                                                                                                                                                                                                                                                                                                                                           #
# #   A string with a confirmation message indicating whether the                                                                                                                                                                                                                                                                                                                                                                                      #
# #   operation was successful.                                                                                                                                                                                                                                                                                                                                                                                                                        #
# #                                                                                                                                                                                                                                                                                                                                                                                                                                                    #
# def modify_file(filename: str, changes: str) -> str:                                                                                                                                                                                                                                                                                                                                                                                                 #
#     ...                                                                                                                                                                                                                                                                                                                                                                                                                                              #
#                                                                                                                                                                                                                                                                                                                                                                                                                                                      #
# # Execute a specified Python file in a virtual environment with the                                                                                                                                                                                                                                                                                                                                                                                  #
# # newest Python 3 available.  Only Python files (.py) can be executed.                                                                                                                                                                                                                                                                                                                                                                               #
# #                                                                                                                                                                                                                                                                                                                                                                                                                                                    #
# # Arguments:                                                                                                                                                                                                                                                                                                                                                                                                                                         #
# #   filename - A string specifying the path to the Python file                                                                                                                                                                                                                                                                                                                                                                                       #
# #              relative to the root directory.                                                                                                                                                                                                                                                                                                                                                                                                       #
# #                                                                                                                                                                                                                                                                                                                                                                                                                                                    #
# # Returns:                                                                                                                                                                                                                                                                                                                                                                                                                                           #
# #   A string containing the output of the execution, including any                                                                                                                                                                                                                                                                                                                                                                                   #
# #   error messages, or an error message if the file does not exist or                                                                                                                                                                                                                                                                                                                                                                                #
# #   cannot be executed.                                                                                                                                                                                                                                                                                                                                                                                                                              #
# #                                                                                                                                                                                                                                                                                                                                                                                                                                                    #
# def run_file(filename: str) -> str:                                                                                                                                                                                                                                                                                                                                                                                                                  #
#     ...                                                                                                                                                                                                                                                                                                                                                                                                                                              #
#                                                                                                                                                                                                                                                                                                                                                                                                                                                      #
# # Read the contents of a specified file.                                                                                                                                                                                                                                                                                                                                                                                                             #
# #                                                                                                                                                                                                                                                                                                                                                                                                                                                    #
# # Arguments:                                                                                                                                                                                                                                                                                                                                                                                                                                         #
# #   filename - A string specifying the path to the file relative to                                                                                                                                                                                                                                                                                                                                                                                  #
# #              the root directory.                                                                                                                                                                                                                                                                                                                                                                                                                   #
# #                                                                                                                                                                                                                                                                                                                                                                                                                                                    #
# # Returns:                                                                                                                                                                                                                                                                                                                                                                                                                                           #
# #   A list of strings, where each string is a chunk of the file                                                                                                                                                                                                                                                                                                                                                                                      #
# #   content. For small files, this may be a list with a single string                                                                                                                                                                                                                                                                                                                                                                                #
# #   containing the entire content. For large files, it will be split                                                                                                                                                                                                                                                                                                                                                                                 #
# #   into multiple chunks. If the file does not exist, a string with an                                                                                                                                                                                                                                                                                                                                                                               #
# #   error message is returned (e.g., "Error: File not found").                                                                                                                                                                                                                                                                                                                                                                                       #
# #                                                                                                                                                                                                                                                                                                                                                                                                                                                    #
# def read_file(filename: str) -> str:                                                                                                                                                                                                                                                                                                                                                                                                                 #
#     ...                                                                                                                                                                                                                                                                                                                                                                                                                                              #
#                                                                                                                                                                                                                                                                                                                                                                                                                                                      #
# # List all files in the root directory and its subdirectories.                                                                                                                                                                                                                                                                                                                                                                                       #
# #                                                                                                                                                                                                                                                                                                                                                                                                                                                    #
# # No Arguments.                                                                                                                                                                                                                                                                                                                                                                                                                                      #
# #                                                                                                                                                                                                                                                                                                                                                                                                                                                    #
# # Returns:                                                                                                                                                                                                                                                                                                                                                                                                                                           #
# #   A list of strings, where each string is a file path relative to the root                                                                                                                                                                                                                                                                                                                                                                         #
# #   directory.                                                                                                                                                                                                                                                                                                                                                                                                                                       #
# #                                                                                                                                                                                                                                                                                                                                                                                                                                                    #
# def see_all_files() -> list[str]:                                                                                                                                                                                                                                                                                                                                                                                                                    #
#     ...                                                                                                                                                                                                                                                                                                                                                                                                                                              #
#                                                                                                                                                                                                                                                                                                                                                                                                                                                      #
# # Install a specified Python module in the virtual environment.                                                                                                                                                                                                                                                                                                                                                                                      #
# #                                                                                                                                                                                                                                                                                                                                                                                                                                                    #
# # Arguments:                                                                                                                                                                                                                                                                                                                                                                                                                                         #
# #   dependency - A string specifying the name of the Python module to                                                                                                                                                                                                                                                                                                                                                                                #
# #                install (e.g., "numpy").                                                                                                                                                                                                                                                                                                                                                                                                            #
# #                                                                                                                                                                                                                                                                                                                                                                                                                                                    #
# # Returns:                                                                                                                                                                                                                                                                                                                                                                                                                                           #
# #   A string with a confirmation message indicating whether the                                                                                                                                                                                                                                                                                                                                                                                      #
# #   installation was successful (e.g., "Dependency 'numpy' installed                                                                                                                                                                                                                                                                                                                                                                                 #
# #   successfully").                                                                                                                                                                                                                                                                                                                                                                                                                                  #
# #                                                                                                                                                                                                                                                                                                                                                                                                                                                    #
# def install_dependency(dependency: str) -> str:                                                                                                                                                                                                                                                                                                                                                                                                      #
#     ...                                                                                                                                                                                                                                                                                                                                                                                                                                              #
# ```                                                                                                                                                                                                                                                                                                                                                                                                                                                  #
# """.strip()                                                                                                                                                                                                                                                                                                                                                                                                                                          #
#     prompt = """                                                                                                                                                                                                                                                                                                                                                                                                                                     #
# Provided objective:                                                                                                                                                                                                                                                                                                                                                                                                                                  #
# ```                                                                                                                                                                                                                                                                                                                                                                                                                                                  #
# Write a function to compute the Fibonacci sequence.                                                                                                                                                                                                                                                                                                                                                                                                  #
# ```                                                                                                                                                                                                                                                                                                                                                                                                                                                  #
#                                                                                                                                                                                                                                                                                                                                                                                                                                                      #
# Operational history:                                                                                                                                                                                                                                                                                                                                                                                                                                 #
# ```                                                                                                                                                                                                                                                                                                                                                                                                                                                  #
# I chose to create a new file (`create_file`) because it is the most direct and efficient way to start implementing the Fibonacci sequence function. By creating a new file, I can write the function in isolation and focus on its implementation without being distracted by existing code or file structure. This allows me to start with a clean slate and write high-quality, readable, and maintainable code.                                   #
#                                                                                                                                                                                                                                                                                                                                                                                                                                                      #
# Created a Python file named `fibonacci.py` with the Fibonacci function and unit tests, successfully writing 1046 bytes of content.                                                                                                                                                                                                                                                                                                                   #
#                                                                                                                                                                                                                                                                                                                                                                                                                                                      #
# I chose to use the `modify_file` action to add extensive comments throughout the code, as it is essential to document and make the code readable before running tests and verifying their pass rate.                                                                                                                                                                                                                                                 #
#                                                                                                                                                                                                                                                                                                                                                                                                                                                      #
# Added extensive comments throughout the Fibonacci function and unit tests in `fibonacci.py`.                                                                                                                                                                                                                                                                                                                                                         #
#                                                                                                                                                                                                                                                                                                                                                                                                                                                      #
# I chose to run the file (`run_file`) because I want to verify that the Fibonacci function and unit tests are working correctly, ensuring that the implementation meets the requirements and is free of errors. This action will provide me with the test results, allowing me to confirm that the code is functioning as expected.                                                                                                                   #
#                                                                                                                                                                                                                                                                                                                                                                                                                                                      #
# Ran Fibonacci function with unit tests in `fibonacci.py` and verified pass rate of 100% using verbose mode.                                                                                                                                                                                                                                                                                                                                          #
# ```                                                                                                                                                                                                                                                                                                                                                                                                                                                  #
#                                                                                                                                                                                                                                                                                                                                                                                                                                                      #
# """.strip()                                                                                                                                                                                                                                                                                                                                                                                                                                          #
#                                                                                                                                                                                                                                                                                                                                                                                                                                                      #
#     # alternates = rephrase("Given the objective and history of operations, succinctly and in one or two sentences describe what do you think the general next step that should be taken according to the manual.")                                                                                                                                                                                                                                  #
#     question = "Given the current history of operation, does it appear that the objective has been completely satisfied in accordance with all criteria listed in the manual? Explain your thinking."                                                                                                                                                                                                                                                #
#                                                                                                                                                                                                                                                                                                                                                                                                                                                      #
#     alternates = rephrase(prompt)                                                                                                                                                                                                                                                                                                                                                                                                                    #
#     for _ in alternates:                                                                                                                                                                                                                                                                                                                                                                                                                             #
#         print("_"*100)                                                                                                                                                                                                                                                                                                                                                                                                                               #
#         print(_)                                                                                                                                                                                                                                                                                                                                                                                                                                     #
#         print()                                                                                                                                                                                                                                                                                                                                                                                                                                      #
#     exit()                                                                                                                                                                                                                                                                                                                                                                                                                                           #
#                                                                                                                                                                                                                                                                                                                                                                                                                                                      #
#     completion = complete_from_options(                                                                                                                                                                                                                                                                                                                                                                                                              #
#         messages=[                                                                                                                                                                                                                                                                                                                                                                                                                                   #
#             manual,                                                                                                                                                                                                                                                                                                                                                                                                                                  #
#             "I see you have provided a manual. How can I help?",                                                                                                                                                                                                                                                                                                                                                                                     #
#             prompt + question,                                                                                                                                                                                                                                                                                                                                                                                                                       #
#         ],                                                                                                                                                                                                                                                                                                                                                                                                                                           #
#         temperature=0.0,                                                                                                                                                                                                                                                                                                                                                                                                                             #
#         reasoning_attempts=5,                                                                                                                                                                                                                                                                                                                                                                                                                        #
#         options=["Yes", "No"],                                                                                                                                                                                                                                                                                                                                                                                                                       #
#     )                                                                                                                                                                                                                                                                                                                                                                                                                                                #
#     print("completion: ")                                                                                                                                                                                                                                                                                                                                                                                                                            #
#     print()                                                                                                                                                                                                                                                                                                                                                                                                                                          #
#     print(completion, flush=True)                                                                                                                                                                                                                                                                                                                                                                                                                    #
#     exit()                                                                                                                                                                                                                                                                                                                                                                                                                                           #
#                                                                                                                                                                                                                                                                                                                                                                                                                                                      #
#                                                                                                                                                                                                                                                                                                                                                                                                                                                      #
#     alternates = rephrase(question)                                                                                                                                                                                                                                                                                                                                                                                                                  #
#     for _ in alternates:                                                                                                                                                                                                                                                                                                                                                                                                                             #
#         print()                                                                                                                                                                                                                                                                                                                                                                                                                                      #
#         print(_)                                                                                                                                                                                                                                                                                                                                                                                                                                     #
#         print()                                                                                                                                                                                                                                                                                                                                                                                                                                      #
#     # exit()                                                                                                                                                                                                                                                                                                                                                                                                                                         #
#                                                                                                                                                                                                                                                                                                                                                                                                                                                      #
#     # response = "According to the manual, the next step would be to write a function to compute the Fibonacci sequence, which has already been done in the `fibonacci.py` file. The next step would likely be to use the `run_file` action again, but this time with a test case that covers the edge cases or boundary conditions of the Fibonacci sequence function, to further verify its correctness and ensure it meets the requirements."     #
#     # counter = "I made a mistake. According to the manual, after writing the Fibonacci function and unit tests in `fibonacci.py`, the next step would be to use the `modify_file` action to add extensive comments throughout the code, which has already been done. Therefore, the next step would likely be to run the file (`run_file`) again with verbose mode to verify that the implementation meets the requirements and is free of errors." #
#                                                                                                                                                                                                                                                                                                                                                                                                                                                      #
#     for a in alternates:                                                                                                                                                                                                                                                                                                                                                                                                                             #
#         print("-"*100)                                                                                                                                                                                                                                                                                                                                                                                                                               #
#         # completion = complete_from_options(                                                                                                                                                                                                                                                                                                                                                                                                        #
#         completion, _ = chat_complete(                                                                                                                                                                                                                                                                                                                                                                                                               #
#             messages=[                                                                                                                                                                                                                                                                                                                                                                                                                               #
#                 manual,                                                                                                                                                                                                                                                                                                                                                                                                                              #
#                 "I see you have provided a manual. How can I help?",                                                                                                                                                                                                                                                                                                                                                                                 #
#                 prompt + a,                                                                                                                                                                                                                                                                                                                                                                                                                          #
#                 # response,                                                                                                                                                                                                                                                                                                                                                                                                                          #
#                 # "Think about it more.",                                                                                                                                                                                                                                                                                                                                                                                                            #
#                 # "Are you sure?",                                                                                                                                                                                                                                                                                                                                                                                                                   #
#                 # counter,                                                                                                                                                                                                                                                                                                                                                                                                                           #
#                 # "Are your new thoughts consistent with your original response?",                                                                                                                                                                                                                                                                                                                                                                   #
#                 # "Given your new thoughts, was your original response correct?",                                                                                                                                                                                                                                                                                                                                                                    #
#                 # "No.",                                                                                                                                                                                                                                                                                                                                                                                                                             #
#                 # "Please respond with a new and refined response.",                                                                                                                                                                                                                                                                                                                                                                                 #
#             ],                                                                                                                                                                                                                                                                                                                                                                                                                                       #
#             temperature=0.0,                                                                                                                                                                                                                                                                                                                                                                                                                         #
#             # options=["Yes", "No"],                                                                                                                                                                                                                                                                                                                                                                                                                 #
#         )                                                                                                                                                                                                                                                                                                                                                                                                                                            #
#         print()                                                                                                                                                                                                                                                                                                                                                                                                                                      #
#         print(completion, flush=True)                                                                                                                                                                                                                                                                                                                                                                                                                #
#         print()                                                                                                                                                                                                                                                                                                                                                                                                                                      #
########################################################################################################################################################################################################################################################################################################################################################################################################################################################
